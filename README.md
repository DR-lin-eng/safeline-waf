# SafeLine WAF 防护系统 - 详细文档

## 目录

1. [概述](#概述)
2. [核心功能](#核心功能)
3. [系统架构](#系统架构)
4. [安装指南](#安装指南)
5. [配置指南](#配置指南)
6. [防护机制详解](#防护机制详解)
7. [常见问题](#常见问题)
8. [性能优化](#性能优化)
9. [API参考](#api参考)
10. [贡献指南](#贡献指南)

## 概述

SafeLine WAF 是一个基于 OpenResty (Nginx + Lua) 的高性能 Web 应用防火墙，专为防御各类网络攻击特别是 DDoS 攻击而设计。它提供全面的 HTTP/HTTPS 流量分析和防护功能，能够识别并阻止恶意请求，同时对正常用户的访问影响最小。

SafeLine WAF 的主要特点：

- **高性能**：基于 Nginx 和 OpenResty，能够处理高并发流量
- **智能防护**：采用多层防护策略，动态识别攻击行为
- **低误判**：通过多种验证机制减少误判，提高用户体验
- **易于管理**：提供直观的管理界面，方便配置和监控
- **可扩展**：支持自定义规则和插件扩展

## 核心功能

SafeLine WAF 提供以下核心防护功能：

### 流量控制与分析

- **真实浏览器检测**：识别并过滤非浏览器的自动化请求
- **环境监测**：识别可疑的请求环境
- **IP 速率限制**：限制单个 IP 的请求频率
- **IP 黑名单**：阻止已知的恶意 IP 地址
- **流量动态识别**：实时分析流量模式，识别异常行为

### DDoS 防护

- **URL 级 DDoS 防护**：针对特定 URL 的动态防护
- **Anti-CC 防护**：防止恶意的高频请求攻击
- **随机参数攻击防护**：识别使用随机参数和请求方法的 DDoS 攻击
- **慢速 DDoS 防护**：防止消耗服务器连接资源的慢速攻击

### 用户验证

- **验证码**：传统的字符验证码
- **滑块验证**：用户友好的滑块拖动验证
- **POW 工作量证明**：在检测到攻击时，要求客户端完成计算工作

### 客户端防护

- **JS 加密**：对客户端 JavaScript 进行加密，防止逆向分析
- **F12 防护**：阻止恶意用户使用开发者工具分析页面

### 其他功能

- **蜜罐系统**：设置陷阱链接，捕获恶意扫描行为
- **实时监控**：提供详细的流量统计和攻击日志
- **自动封禁**：根据攻击行为自动将 IP 添加到黑名单

## 系统架构

SafeLine WAF 采用模块化架构，主要由以下组件构成：

### 核心组件

1. **Nginx + OpenResty**：提供高性能的 HTTP 服务器和反向代理能力
2. **Lua 脚本引擎**：执行核心防护逻辑
3. **Redis**：存储状态、计数器和黑名单等数据
4. **管理系统**：Vue.js 前端 + Node.js 后端

### 数据流图

```
                           ┌───────────────┐
                           │    客户端     │
                           └───────┬───────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────┐
│                  SafeLine WAF                        │
│                                                      │
│   ┌───────────┐     ┌───────────┐     ┌──────────┐   │
│   │访问控制模块│ ─── │DDoS防护模块│ ─── │验证处理模块│   │
│   └───────────┘     └───────────┘     └──────────┘   │
│                                                      │
│   ┌───────────┐     ┌───────────┐     ┌──────────┐   │
│   │  Redis    │ ─── │状态和计数器│ ─── │  日志系统 │   │
│   └───────────┘     └───────────┘     └──────────┘   │
│                                                      │
└──────────────────────────┬──────────────────────────┘
                           │
                           ▼
                   ┌─────────────────┐
                   │  后端应用服务器  │
                   └─────────────────┘
```

### 模块交互

1. **访问控制模块**：检查请求的 IP、User-Agent 等基本信息，进行初步过滤
2. **DDoS 防护模块**：分析请求模式，检测可能的 DDoS 攻击
3. **验证处理模块**：当检测到可疑请求时，生成并验证验证码、滑块或 POW 挑战
4. **Redis 存储**：存储临时数据，如计数器、令牌和黑名单
5. **状态和计数器**：跟踪请求频率和模式
6. **日志系统**：记录请求和攻击信息

## 安装指南

### 系统要求

- **操作系统**：Linux（推荐 Ubuntu 20.04+、CentOS 7+）
- **CPU**：2+ 核心
- **内存**：4GB+ RAM
- **磁盘空间**：20GB+ 可用空间
- **软件**：Docker 和 Docker Compose

### 使用安装脚本快速部署

```bash
# 下载安装脚本
wget https://raw.githubusercontent.com/DR-lin-eng/safeline-waf/main/scripts/install.sh

# 添加执行权限
chmod +x install.sh

# 运行安装脚本
sudo ./install.sh
```

### 使用 Docker Compose 手动部署

1. 克隆代码仓库：

```bash
git clone https://github.com/DR-lin-eng/safeline-waf.git
cd safeline-waf
```

2. 配置环境：

```bash
# 创建必要的目录
mkdir -p config/sites logs
```

3. 启动服务：

```bash
docker-compose up -d
```

4. 验证安装：

访问 `http://您的服务器IP:8080` 登录管理界面。

默认管理员账号：
- 用户名：admin
- 密码：safeline123

## 配置指南

### 通过管理界面配置

1. 登录管理界面 `http://您的服务器IP:8080`
2. 首次登录后，建议修改默认密码
3. 在"站点管理"中添加新站点：
   - 填写域名
   - 设置后端服务器地址
   - 选择防护功能

### 站点配置项说明

#### 基本配置

- **域名**：网站的域名，例如 example.com
- **后端服务器**：实际应用服务器的地址，例如 http://192.168.1.10:8080
- **启用状态**：是否启用该站点的 WAF 防护

#### 防护功能

- **真实浏览器检测**：识别并过滤非浏览器的自动化请求
- **环境监测**：识别可疑的请求环境
- **IP 黑名单**：启用 IP 黑名单功能
- **全局速率限制**：限制单个 IP 的请求频率
- **DDoS 防护**：启用 DDoS 攻击防护
- **随机攻击防护**：识别随机参数和请求方法的攻击
- **Anti-CC 防护**：防止恶意的高频请求
- **JS 加密**：对客户端 JavaScript 进行加密
- **防止浏览器 F12**：阻止恶意用户使用开发者工具
- **蜜罐功能**：设置陷阱链接捕获恶意扫描
- **自动添加 IP 黑名单**：根据攻击行为自动封禁 IP
- **请求日志记录**：记录请求和攻击信息
- **流量动态识别**：实时分析流量模式

#### 验证方式

- **验证码**：传统的字符验证码
- **滑块验证**：用户友好的滑块拖动验证
- **工作量证明(POW)**：要求客户端完成计算工作
- **POW 基础难度**：工作量证明的基础难度级别(1-10)
- **POW 最大难度**：工作量证明的最大难度级别(1-15)

#### 验证方式关联

- **IP 地址**：验证结果与 IP 地址关联
- **User-Agent**：验证结果与 User-Agent 关联
- **Cookie**：验证结果与 Cookie 关联

## 防护机制详解

### URL 级 DDoS 防护

URL 级 DDoS 防护是 SafeLine WAF 的核心功能之一，它能够针对特定 URL 提供动态防护。

#### 工作原理

1. **URL 规范化**：将包含随机部分的 URL 转换为统一格式，便于统计和分析
2. **请求计数**：跟踪每个客户端对特定 URL 的请求频率
3. **动态阈值**：根据全局流量和历史数据动态调整阈值
4. **行为分析**：分析客户端行为模式，识别异常行为
5. **请求特征分析**：分析请求头、参数等特征，识别自动化工具
6. **多级响应**：根据威胁级别采取不同的应对措施

#### 防护策略

当检测到可能的 DDoS 攻击时，系统会根据威胁级别采取以下措施：

1. **低威胁**：展示简单的验证码
2. **中威胁**：要求滑块验证
3. **高威胁**：要求完成工作量证明(POW)
4. **极高威胁**：直接拒绝请求并自动将 IP 添加到黑名单

### 工作量证明 (POW) 机制

POW 是一种高效的防护机制，特别适用于防御大规模 DDoS 攻击。它要求客户端执行一定量的计算工作，这对普通用户几乎无感知，但会显著增加攻击者的成本。

#### 工作原理

1. **挑战生成**：服务器生成一个随机前缀和难度级别
2. **客户端计算**：客户端需要找到一个 nonce 值，使得 SHA-256(prefix + nonce) 的前 n 位为 0
3. **服务器验证**：服务器验证计算结果，验证通过后允许访问

#### 难度调整

系统会根据以下因素动态调整 POW 难度：

- **全局流量状况**：流量越大，难度越高
- **客户端历史行为**：可疑行为越多，难度越高
- **攻击强度**：检测到的攻击强度越大，难度越高

### 流量动态识别

流量动态识别功能通过实时分析流量模式，识别异常行为，是系统防御未知攻击的重要组成部分。

#### 识别维度

1. **请求频率**：分析请求的时间间隔和频率
2. **HTTP 方法分布**：分析 GET、POST 等方法的使用比例
3. **URL 分布**：分析访问的 URL 分布情况
4. **参数特征**：分析请求参数的特征和变化
5. **响应状态码**：分析响应状态码的分布
6. **客户端指纹**：分析客户端的特征指纹

#### 异常检测算法

系统使用多种算法进行异常检测：

1. **聚类分析**：将请求特征向量进行聚类，识别离群点
2. **时间序列分析**：分析请求时间序列的规律性
3. **熵值分析**：计算请求特征的熵值，识别异常分布
4. **行为模式匹配**：将客户端行为与已知攻击模式进行匹配

## 常见问题

### 1. WAF 影响网站性能吗？

SafeLine WAF 被设计为高性能防护系统，在正常情况下对性能影响很小（通常小于 5ms 的延迟）。系统使用多级缓存、共享内存和异步处理等技术来最小化性能影响。

### 2. 如何处理误判？

误判是所有 WAF 系统面临的挑战。我们通过以下方式减少误判：

- 多重验证机制，避免直接拒绝请求
- 基于用户行为的信誉系统
- 白名单机制
- 详细的日志，便于分析和调整

如果发现误判，可以：
1. 检查日志，找出触发规则
2. 调整相应规则的敏感度
3. 为特定 IP 或路径添加白名单

### 3. 如何配置 HTTPS？

要配置 HTTPS 支持，您需要：

1. 准备 SSL 证书文件
2. 将证书文件放入 `nginx/certs/` 目录
3. 在管理界面中为站点启用 HTTPS
4. 提供证书文件路径
5. 重启服务以应用更改

### 4. 系统日志在哪里？

日志文件位于以下位置：

- Nginx 访问日志：`logs/access.log`
- Nginx 错误日志：`logs/error.log`
- 应用日志：`logs/app.log`
- Docker 容器日志：使用 `docker logs safeline-waf-nginx` 查看

## 性能优化

### 硬件推荐

- **小型网站**：2 核 CPU, 4GB 内存
- **中型网站**：4 核 CPU, 8GB 内存
- **大型网站**：8+ 核 CPU, 16GB+ 内存

### Nginx 优化

编辑 `nginx/nginx.conf` 文件，调整以下参数：

```nginx
worker_processes auto;  # 设置为 CPU 核心数
worker_connections 10240;  # 增加连接数
worker_rlimit_nofile 65535;  # 增加文件描述符限制
```

### Redis 优化

编辑 `docker-compose.yml` 中的 Redis 配置，添加以下参数：

```yaml
command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru
```

### Lua 脚本优化

- 使用共享内存缓存减少 Redis 查询
- 异步处理非阻塞操作
- 减少不必要的计算

## API 参考

SafeLine WAF 提供 RESTful API，便于与其他系统集成。

### 认证

所有 API 请求都需要通过 API 密钥进行认证：

```
Header: X-API-Key: your_api_key_here
```

### 主要 API 端点

- `GET /api/stats` - 获取统计数据
- `GET /api/sites` - 获取站点列表
- `PUT /api/sites/:domain` - 更新站点配置
- `GET /api/blacklist` - 获取黑名单
- `POST /api/blacklist` - 添加 IP 到黑名单
- `DELETE /api/blacklist/:ip` - 从黑名单中删除 IP
- `GET /api/logs` - 获取日志

详细 API 文档请参考 `/docs/api.md`。

## 贡献指南

我们欢迎社区贡献，无论是功能开发、bug 修复还是文档改进。

### 贡献步骤

1. Fork 仓库
2. 创建特性分支：`git checkout -b my-new-feature`
3. 提交更改：`git commit -am 'Add some feature'`
4. 推送到分支：`git push origin my-new-feature`
5. 提交 Pull Request

### 代码风格

- Lua 代码遵循 [lua-style-guide](https://github.com/Olivine-Labs/lua-style-guide)
- JavaScript 代码遵循 ESLint 配置
- 所有新功能必须包含测试用例
- 所有 Pull Request 必须通过 CI 测试

---

## 许可证

SafeLine WAF 使用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。
